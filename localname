local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- 存储所有玩家的自定义名字
local customNames = {}

-- 获取玩家头顶的BillboardGui
local function updatePlayerNameTag(targetPlayer, newName)
	local character = targetPlayer.Character
	if not character then return end
	
	local head = character:FindFirstChild("Head")
	if not head then return end
	
	-- 查找现有的名字标签
	local billboard = head:FindFirstChild("BillboardGui")
	if billboard then
		local nameLabel = billboard:FindFirstChild("NameLabel")
		if nameLabel then
			nameLabel.Text = newName
		end
	end
	
	-- 同时更新Humanoid的DisplayName（影响聊天框等）
	local humanoid = character:FindFirstChild("Humanoid")
	if humanoid then
		humanoid.DisplayName = newName
	end
end

-- 持续更新所有玩家的名字（因为角色可能会重生）
local function setupNameUpdater()
	RunService.RenderStepped:Connect(function()
		for targetPlayer, newName in pairs(customNames) do
			if targetPlayer and newName then
				updatePlayerNameTag(targetPlayer, newName)
			end
		end
	end)
end
setupNameUpdater()

-- 创建主界面
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NameChangerGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- 主窗口
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 350, 0, 280)
mainFrame.Position = UDim2.new(0.5, -175, 0.5, -140)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Parent = screenGui

-- 标题栏
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -60, 1, 0)
titleLabel.Position = UDim2.new(0, 0, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "玩家名字修改器"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.SourceSans
titleLabel.TextSize = 18
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

-- 最小化按钮
local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 30, 1, 0)
minimizeButton.Position = UDim2.new(1, -60, 0, 0)
minimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
minimizeButton.Text = "−"
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.Font = Enum.Font.SourceSans
minimizeButton.TextSize = 20
minimizeButton.BorderSizePixel = 0
minimizeButton.Parent = titleBar

-- 关闭按钮
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSans
closeButton.TextSize = 20
closeButton.BorderSizePixel = 0
closeButton.Parent = titleBar

-- 内容区域
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, 0, 1, -30)
contentFrame.Position = UDim2.new(0, 0, 0, 30)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- 玩家选择下拉框
local selectorLabel = Instance.new("TextLabel")
selectorLabel.Size = UDim2.new(0.8, 0, 0, 25)
selectorLabel.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 10)
selectorLabel.BackgroundTransparency = 1
selectorLabel.Text = "选择要改名的玩家："
selectorLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
selectorLabel.Font = Enum.Font.SourceSans
selectorLabel.TextSize = 18
selectorLabel.TextXAlignment = Enum.TextXAlignment.Left
selectorLabel.Parent = contentFrame

local dropdownButton = Instance.new("TextButton")
dropdownButton.Size = UDim2.new(0.8, 0, 0, 30)
dropdownButton.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 35)
dropdownButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
dropdownButton.Text = "点击选择玩家"
dropdownButton.TextColor3 = Color3.fromRGB(255, 255, 255)
dropdownButton.Font = Enum.Font.SourceSans
dropdownButton.TextSize = 18
dropdownButton.BorderSizePixel = 0
dropdownButton.Parent = contentFrame

-- 下拉列表容器
local dropdownList = Instance.new("ScrollingFrame")
dropdownList.Size = UDim2.new(0.8, 0, 0, 100)
dropdownList.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 65)
dropdownList.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
dropdownList.BorderSizePixel = 0
dropdownList.ScrollBarThickness = 8
dropdownList.Visible = false
dropdownList.Parent = contentFrame

-- 当前选中玩家的名字标签
local selectedPlayerLabel = Instance.new("TextLabel")
selectedPlayerLabel.Size = UDim2.new(0.8, 0, 0, 25)
selectedPlayerLabel.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 110)
selectedPlayerLabel.BackgroundTransparency = 1
selectedPlayerLabel.Text = "当前选中：无"
selectedPlayerLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
selectedPlayerLabel.Font = Enum.Font.SourceSans
selectedPlayerLabel.TextSize = 16
selectedPlayerLabel.TextXAlignment = Enum.TextXAlignment.Left
selectedPlayerLabel.Parent = contentFrame

-- 输入框
local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(0.8, 0, 0, 30)
textBox.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 140)
textBox.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
textBox.PlaceholderText = "输入新名字..."
textBox.Text = ""
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Font = Enum.Font.SourceSans
textBox.TextSize = 18
textBox.ClearTextOnFocus = false
textBox.Parent = contentFrame

-- 替换按钮
local replaceButton = Instance.new("TextButton")
replaceButton.Size = UDim2.new(0.8, 0, 0, 40)
replaceButton.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 180)
replaceButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
replaceButton.Text = "替换名字"
replaceButton.TextColor3 = Color3.fromRGB(255, 255, 255)
replaceButton.Font = Enum.Font.SourceSans
replaceButton.TextSize = 20
replaceButton.BorderSizePixel = 0
replaceButton.Parent = contentFrame

-- 状态标签
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(0.8, 0, 0, 30)
statusLabel.Position = UDim2.new(0.5, -0.5*0.8*350, 0, 225)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "等待操作..."
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 16
statusLabel.Parent = contentFrame

-- 数据
local selectedPlayer = nil
local playerButtons = {}

-- 更新下拉列表
local function updatePlayerList()
	for _, btn in ipairs(playerButtons) do
		btn:Destroy()
	end
	playerButtons = {}

	local allPlayers = Players:GetPlayers()
	local yOffset = 0
	local buttonHeight = 30

	for _, plr in ipairs(allPlayers) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, 0, 0, buttonHeight)
		btn.Position = UDim2.new(0, 0, 0, yOffset)
		btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
		btn.Text = plr.Name .. (plr == player and " (自己)" or "")
		btn.TextColor3 = Color3.fromRGB(255, 255, 255)
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 16
		btn.BorderSizePixel = 0
		btn.Parent = dropdownList

		btn.MouseButton1Click:Connect(function()
			selectedPlayer = plr
			dropdownButton.Text = plr.Name
			selectedPlayerLabel.Text = "当前选中：" .. plr.Name .. " (原名: " .. plr.DisplayName .. ")"
			dropdownList.Visible = false
			
			-- 如果该玩家已经有自定义名字，显示在输入框
			if customNames[plr] then
				textBox.Text = customNames[plr]
			else
				textBox.Text = ""
			end
		end)

		table.insert(playerButtons, btn)
		yOffset = yOffset + buttonHeight
	end

	dropdownList.CanvasSize = UDim2.new(0, 0, 0, yOffset)
end

-- 初始填充
updatePlayerList()

-- 监听玩家加入/离开
Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(function()
	updatePlayerList()
	-- 如果被移除的玩家是当前选中的，清空选择
	if selectedPlayer and not Players:FindFirstChild(selectedPlayer.Name) then
		selectedPlayer = nil
		dropdownButton.Text = "点击选择玩家"
		selectedPlayerLabel.Text = "当前选中：无"
	end
end)

-- 下拉按钮点击
dropdownButton.MouseButton1Click:Connect(function()
	dropdownList.Visible = not dropdownList.Visible
end)

-- 点击其他地方关闭下拉列表
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		local mousePos = Vector2.new(input.Position.X, input.Position.Y)
		
		-- 检查是否点击在下拉列表外
		if dropdownList.Visible then
			local listPos = dropdownList.AbsolutePosition
			local listSize = dropdownList.AbsoluteSize
			local inList = mousePos.X >= listPos.X and mousePos.X <= listPos.X + listSize.X and
						  mousePos.Y >= listPos.Y and mousePos.Y <= listPos.Y + listSize.Y
			
			local btnPos = dropdownButton.AbsolutePosition
			local btnSize = dropdownButton.AbsoluteSize
			local inButton = mousePos.X >= btnPos.X and mousePos.X <= btnPos.X + btnSize.X and
							mousePos.Y >= btnPos.Y and mousePos.Y <= btnPos.Y + btnSize.Y
			
			if not inList and not inButton then
				dropdownList.Visible = false
			end
		end
	end
end)

-- 替换按钮点击事件 - 这才是真正修改名字的地方！
replaceButton.MouseButton1Click:Connect(function()
	local newName = textBox.Text
	if selectedPlayer and newName ~= "" then
		-- 保存自定义名字
		customNames[selectedPlayer] = newName
		
		-- 立即更新该玩家的名字
		updatePlayerNameTag(selectedPlayer, newName)
		
		statusLabel.Text = "✅ 已修改 " .. selectedPlayer.Name .. " 的名字为: " .. newName
		textBox.Text = ""  -- 清空输入框
		
		-- 更新选中标签显示
		selectedPlayerLabel.Text = "当前选中：" .. selectedPlayer.Name .. " (已改为: " .. newName .. ")"
	elseif not selectedPlayer then
		statusLabel.Text = "❌ 请先选择一个玩家"
	else
		statusLabel.Text = "❌ 请输入新名字"
	end
end)

-- 拖动功能
local dragging = false
local dragInput, dragStart, startPos

local function updateDrag(input)
	local delta = input.Position - dragStart
	mainFrame.Position = UDim2.new(
		startPos.X.Scale, startPos.X.Offset + delta.X,
		startPos.Y.Scale, startPos.Y.Offset + delta.Y
	)
end

titleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position

		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

titleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		updateDrag(input)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

-- 缩小功能
local minimized = false
local originalSize = mainFrame.Size
local minimizedSize = UDim2.new(0, 350, 0, 30)

minimizeButton.MouseButton1Click:Connect(function()
	minimized = not minimized
	if minimized then
		contentFrame.Visible = false
		mainFrame.Size = minimizedSize
		minimizeButton.Text = "□"
	else
		contentFrame.Visible = true
		mainFrame.Size = originalSize
		minimizeButton.Text = "−"
	end
end)

-- 关闭功能
closeButton.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

-- 初始化：如果有角色，立即更新名字
player.CharacterAdded:Connect(function(character)
	-- 当自己角色重生时，重新应用所有自定义名字
	task.wait(0.5)  -- 等待角色完全加载
	for targetPlayer, newName in pairs(customNames) do
		updatePlayerNameTag(targetPlayer, newName)
	end
end)
--欢迎魔改
